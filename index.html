<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat IA</title>
<style>
body {
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
  background-color: #2c2c2c;
  font-family: sans-serif;
}

.chat-area {
  width: 640px;
  max-width: 90%;
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  padding: 10px;
  box-sizing: border-box;
}

.message.user {
  align-self: flex-end;
  background-color: #3a3a3a;
  color: white;
  border-radius: 16px;
  padding: 10px;
  margin: 5px 0;
  max-width: 70%;
  word-wrap: break-word;
}

.message.ai {
  align-self: flex-start;
  background-color: transparent;
  color: white;
  border-radius: 16px;
  padding: 10px;
  margin: 5px 0;
  max-width: 70%;
  word-wrap: break-word;
  border: 1px solid #555;
}

.bottom-bar {
  width: 640px;
  height: 56px;
  background-color: #3a3a3a;
  border-radius: 28px;
  display: flex;
  align-items: center;
  margin-bottom: 20px;
  padding: 0 10px;
  box-sizing: border-box;
}

.input-area {
  flex: 1;
  height: 100%;
  border: none;
  background: transparent;
  color: white;
  font-size: 16px;
  padding-left: 20px;
  outline: none;
  caret-color: white;
}

.white-circle {
  width: 36px;
  height: 36px;
  background-color: white;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-left: 10px;
  cursor: pointer;
  transition: transform 0.3s ease;
}

.white-circle:hover { transform: scale(1.3); }
.white-circle:active { transform: scale(1); transition: 0.1s; }

.white-circle svg {
  width: 20px;
  height: 20px;
  fill: black;
}
</style>
</head>
<body>

<div class="chat-area" id="chatArea"></div>

<div class="bottom-bar">
  <input type="text" class="input-area" id="userInput" placeholder="Tapez un message..." />
  <div class="white-circle" id="sendBtn">
    <svg viewBox="0 0 20 20" fill="currentColor">
      <path d="M8.99992 16V6.41407L5.70696 9.70704C5.31643 10.0976 4.68342 10.0976 4.29289 9.70704C3.90237 9.31652 3.90237 8.6835 4.29289 8.29298L9.29289 3.29298L9.36907 3.22462C9.76184 2.90427 10.3408 2.92686 10.707 3.29298L15.707 8.29298L15.7753 8.36915C16.0957 8.76192 16.0731 9.34092 15.707 9.70704C15.3408 10.0732 14.7618 10.0958 14.3691 9.7754L14.2929 9.70704L10.9999 6.41407V16C10.9999 16.5523 10.5522 17 9.99992 17C9.44764 17 8.99992 16.5523 8.99992 16Z"></path>
    </svg>
  </div>
</div>

<script>
const chatArea = document.getElementById("chatArea");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");

let conversation = [];

function addMessage(text, sender){
  const div = document.createElement("div");
  div.classList.add("message", sender);
  div.textContent = text;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}

async function sendMessage() {
  const text = userInput.value.trim();
  if(!text) return;
  addMessage(text, "user");
  conversation.push({ role: "user", content: text });
  userInput.value = "";

  try{
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ conversation })
    });

    const data = await res.json();
    if(data.reply){
      addMessage(data.reply, "ai");
      conversation.push({ role: "ai", content: data.reply });
    } else {
      addMessage("Erreur : aucune réponse de l’IA", "ai");
    }
  } catch(err){
    console.error(err);
    addMessage("Erreur serveur.", "ai");
  }
}

sendBtn.onclick = sendMessage;
userInput.onkeydown = (e)=>{if(e.key==="Enter") sendMessage();};

// Envoi d'un message initial pour "forcer" la première réponse
(async ()=>{
  conversation.push({role:"user", content:"Bonjour"});
  const res = await fetch("/api/chat", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({conversation})
  });
  const data = await res.json();
  if(data.reply){ addMessage(data.reply, "ai"); conversation.push({role:"ai", content:data.reply}); }
})();
</script>

</body>
</html>
